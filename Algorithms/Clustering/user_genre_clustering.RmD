---
title: "Clustering"
author: "Tarun Reddy Aleti"
date: "April 4, 2016"
output: html_document
---
### Executive Summary
- The datasets required for the analysis can be downloaded from these links [Movies](https://inclass.kaggle.com/c/movie/download/movies.dat), [Ratings](https://inclass.kaggle.com/c/movie/download/training_ratings_for_kaggle_comp.csv) and [ReadMe](https://inclass.kaggle.com/c/movie/download/README) 
- Idea is segment users using cluster analysis techniques
- We use *Hierarchical Clustering* and *K-Means Clustering* methods for our analysis.

### Required Packages

Following packages are required for the code to run efficiently.

```{r, echo = TRUE, warning = FALSE, message = FALSE, results = 'hide'}
library(plyr)
library(sqldf)
library(psych)
library(NbClust)
```

### Preliminary Analysis

```{r, echo = TRUE, warning = FALSE, message = FALSE, results = 'hide'}
ratings <- read.csv("training_ratings_for_kaggle_comp.csv", header = TRUE, stringsAsFactors = FALSE)
movieLines <- readLines("movies.dat")
movies <- adply(movieLines, 1, function(x){
  y <- strsplit(x, split = ":")
  return(c(y[[1]][1], y[[1]][3], y[[1]][5]))
})
movies <- movies[ ,-1]
colnames(movies) <- c("MovieID", "Title", "Genres")

genres <- c("Action", "Adventure", "Animation", "Children's",
            "Comedy", "Crime", "Documentary", "Drama", "Fantasy",
            "Film-Noir", "Horror", "Musical", "Mystery", "Romance",
            "Sci-Fi", "Thriller", "War", "Western")

```

- We have two datasets in hand - Movies and Ratings
  1. *Movies*: It has three fields MovieID, MovieTitle and Genres.
    + We can extract the year movie was released using the title name. We can further extract the decade from the year.
    + Movie can belong to more than one of the Genre. We need to create a dummy variable indicating if the movie belong to that Genre or not.
  2. *Ratings*: It has four field UserID, MovieID, Rating and User_Movie_ID
    + All the fields are self explanatory.
    + We need to join all these tables and Rating is our dependent variable for our model.
    
### Feature Extraction

- Create dummy variables for each genre
- Calculate the average rating given by User for genres based upon ratings given by him for that genre

```{r, echo = TRUE, warning = FALSE, message = FALSE, results = 'hide'}
movie_genre <- adply(movies[ ,'Genres'], 1, function(x){
  dummy_genre <- rep(0, length(genres))
  g <- strsplit(x, split = '[|]')
  index_g <- aaply(g[[1]], 1, function(x){
    return(which(genres == x))
  })
  dummy_genre[index_g] <- 1
  return(dummy_genre)
})

movie_genre <- movie_genre[ ,-1]

genres <- c("Action", "Adventure", "Animation", "Childrens",
            "Comedy", "Crime", "Documentary", "Drama", "Fantasy",
            "FilmNoir", "Horror", "Musical", "Mystery", "Romance",
            "SciFi", "Thriller", "War", "Western")
colnames(movie_genre) <- paste("genres", genres, sep = "_")
movies <- cbind(movies, movie_genre)
rownames(movie_genre) <- movies$MovieID

data <- alply(genres, 1, function(genre){
                          query <- paste("SELECT r.user, avg(r.rating * m.genres_", genre,") as avg_", genre, "_rating
                                          FROM ratings as r
                                          INNER JOIN movies as m on r.movie = m.MovieID
                                          WHERE m.genres_", genre, " != 0
                                          GROUP BY r.user
                                          ORDER BY r.user", sep = "")
                          result <- sqldf(query)
                          return(result)
})

user_genre <- ldply(data, function(x){
                      unique_users <- data.frame(unique(ratings$user))
                      colnames(unique_users) <- "user"
                      query <- paste("SELECT u.user, x.*
                                     FROM unique_users as u
                                     LEFT JOIN x as x ON u.user = x.user")
                      result <- sqldf(query)
                      result[is.na(result[ ,3]), 3] <- 0
                      return(data.frame(t(result[ ,3])))
})

user_genre <- t(user_genre)
rownames(user_genre) <- unique(ratings$user)
colnames(user_genre) <- paste("avg", genres, "rating", sep = "_")
